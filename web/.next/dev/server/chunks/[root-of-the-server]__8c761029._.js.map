{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///D:/Maono_App/web/lib/emailService.ts"],"sourcesContent":["import nodemailer from 'nodemailer';\r\n\r\n// Email transporter configuration\r\n// Using Gmail SMTP (requires App Password, not regular password)\r\n// For other providers, adjust the transporter config accordingly\r\nconst transporter = nodemailer.createTransport({\r\n    service: 'gmail',\r\n    auth: {\r\n        user: process.env.EMAIL_USER,\r\n        pass: process.env.EMAIL_PASSWORD, // Gmail App Password (not regular password)\r\n    },\r\n});\r\n\r\n// Alternative: For generic SMTP servers\r\n// const transporter = nodemailer.createTransport({\r\n//   host: process.env.SMTP_HOST,\r\n//   port: parseInt(process.env.SMTP_PORT || '587'),\r\n//   secure: process.env.SMTP_SECURE === 'true', // true for 465, false for other ports\r\n//   auth: {\r\n//     user: process.env.SMTP_USER,\r\n//     pass: process.env.SMTP_PASSWORD,\r\n//   },\r\n// });\r\n\r\ninterface EmailOptions {\r\n    to?: string;\r\n    bcc?: string[];\r\n    subject: string;\r\n    html: string;\r\n    text?: string;\r\n}\r\n\r\nexport async function sendEmail(options: EmailOptions): Promise<boolean> {\r\n    try {\r\n        // Send the email\r\n        const info = await transporter.sendMail({\r\n            from: process.env.EMAIL_USER || 'noreply@kikoba.app',\r\n            to: options.to || undefined,\r\n            bcc: options.bcc || undefined,\r\n            subject: options.subject,\r\n            text: options.text || '',\r\n            html: options.html,\r\n        });\r\n\r\n        console.log(`✅ Email sent successfully. Message ID: ${info.messageId}`);\r\n        return true;\r\n    } catch (error) {\r\n        console.error(`❌ Failed to send email:`, error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Send monthly reminder email to a single admin\r\n */\r\nexport async function sendMonthlyReminder(email: string, name: string): Promise<boolean> {\r\n    const subject = 'KIKOBA Monthly Reminder - Pay Your Loans & Contributions';\r\n\r\n    const htmlContent = `\r\n    <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; color: #333;\">\r\n        <h2 style=\"color: #4CAF50;\">KIKOBA Monthly Reminder</h2>\r\n        \r\n        <p>Dear ${name},</p>\r\n        \r\n        <p>This is a friendly reminder that the end of the month is approaching. Please ensure that:</p>\r\n        \r\n        <ul style=\"line-height: 1.8;\">\r\n            <li><strong>Loan Repayments</strong> - Make your scheduled loan payments on time</li>\r\n            <li><strong>Monthly Contributions</strong> - Submit your contribution for this month</li>\r\n        </ul>\r\n        \r\n        <p>Please log into your KIKOBA account to make any outstanding payments.</p>\r\n        \r\n        <div style=\"background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;\">\r\n            <p style=\"margin: 0; font-size: 12px; color: #666;\">\r\n                <strong>KIKOBA Management System</strong><br/>\r\n                Promoting financial inclusion through group savings\r\n            </p>\r\n        </div>\r\n        \r\n        <p style=\"color: #666; font-size: 12px;\">\r\n            Thank you for being part of the KIKOBA family!\r\n        </p>\r\n    </div>\r\n    `;\r\n\r\n    const textContent = `\r\n    KIKOBA Monthly Reminder\r\n    \r\n    Dear ${name},\r\n    \r\n    This is a friendly reminder that the end of the month is approaching. Please ensure that:\r\n    \r\n    - Loan Repayments: Make your scheduled loan payments on time\r\n    - Monthly Contributions: Submit your contribution for this month\r\n    \r\n    Please log into your KIKOBA account to make any outstanding payments.\r\n    \r\n    Thank you for being part of the KIKOBA family!\r\n    `;\r\n\r\n    return sendEmail({\r\n        to: email,\r\n        subject,\r\n        html: htmlContent,\r\n        text: textContent,\r\n    });\r\n}\r\n\r\n/**\r\n * Send contribution reminder to all members/admins with BCC\r\n */\r\nexport async function sendContributionReminder(recipientEmails: string[], memberNames: string[]): Promise<boolean> {\r\n    const subject = 'KIKOBA Contribution Reminder - Monthly Hisa & Jamii Payment';\r\n\r\n    const htmlContent = `\r\n    <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; color: #333;\">\r\n        <h2 style=\"color: #4CAF50;\">KIKOBA Contribution Reminder</h2>\r\n        \r\n        <p>Dear Member,</p>\r\n        \r\n        <p>This is a friendly reminder to contribute your monthly savings to KIKOBA:</p>\r\n        \r\n        <div style=\"background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin: 20px 0;\">\r\n            <p style=\"margin: 10px 0;\"><strong>Hisa Contribution:</strong> 30,000</p>\r\n            <p style=\"margin: 10px 0;\"><strong>Jamii Contribution:</strong> 5,000</p>\r\n        </div>\r\n        \r\n        <p>Please ensure these contributions are submitted by the end of this month. Contributions are essential to maintain the strength of our group savings scheme.</p>\r\n        \r\n        <p>Log into your KIKOBA account to make your contributions.</p>\r\n        \r\n        <div style=\"background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;\">\r\n            <p style=\"margin: 0; font-size: 12px; color: #666;\">\r\n                <strong>KIKOBA Management System</strong><br/>\r\n                Promoting financial inclusion through group savings\r\n            </p>\r\n        </div>\r\n        \r\n        <p style=\"color: #666; font-size: 12px;\">\r\n            Thank you for being part of the KIKOBA family!\r\n        </p>\r\n    </div>\r\n    `;\r\n\r\n    const textContent = `\r\n    KIKOBA Contribution Reminder\r\n    \r\n    Dear Member,\r\n    \r\n    This is a friendly reminder to contribute your monthly savings to KIKOBA:\r\n    \r\n    Hisa Contribution: 30,000\r\n    Jamii Contribution: 5,000\r\n    \r\n    Please ensure these contributions are submitted by the end of this month.\r\n    \r\n    Log into your KIKOBA account to make your contributions.\r\n    \r\n    Thank you for being part of the KIKOBA family!\r\n    `;\r\n\r\n    return sendEmail({\r\n        bcc: recipientEmails,\r\n        subject,\r\n        html: htmlContent,\r\n        text: textContent,\r\n    });\r\n}\r\n\r\n/**\r\n * Send individual loan repayment reminder with loan balance\r\n */\r\nexport async function sendLoanReminder(email: string, name: string, loans: Array<{ type: string; amount: number; balance: number }>): Promise<boolean> {\r\n    const subject = 'KIKOBA Loan Repayment Reminder - Outstanding Balance';\r\n\r\n    const loanDetails = loans\r\n        .map(\r\n            loan =>\r\n                `<li style=\"margin: 8px 0;\"><strong>${loan.type} Loan</strong> - Balance: ${loan.balance.toLocaleString()} (Original: ${loan.amount.toLocaleString()})</li>`\r\n        )\r\n        .join('');\r\n\r\n    const htmlContent = `\r\n    <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; color: #333;\">\r\n        <h2 style=\"color: #E74C3C;\">KIKOBA Loan Repayment Reminder</h2>\r\n        \r\n        <p>Dear ${name},</p>\r\n        \r\n        <p>You have outstanding loan(s) with KIKOBA. Please review your loan details below and make timely repayments:</p>\r\n        \r\n        <div style=\"background-color: #ffe6e6; padding: 15px; border-radius: 5px; margin: 20px 0;\">\r\n            <p style=\"margin: 0 0 10px 0; font-weight: bold;\">Your Outstanding Loans:</p>\r\n            <ul style=\"margin: 0; padding-left: 20px;\">\r\n                ${loanDetails}\r\n            </ul>\r\n        </div>\r\n        \r\n        <p>Please make your loan repayments as soon as possible to avoid any penalties. Log into your KIKOBA account to make a payment.</p>\r\n        \r\n        <div style=\"background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;\">\r\n            <p style=\"margin: 0; font-size: 12px; color: #666;\">\r\n                <strong>KIKOBA Management System</strong><br/>\r\n                Promoting financial inclusion through group savings\r\n            </p>\r\n        </div>\r\n        \r\n        <p style=\"color: #666; font-size: 12px;\">\r\n            Thank you for being part of the KIKOBA family!\r\n        </p>\r\n    </div>\r\n    `;\r\n\r\n    const loanText = loans.map(loan => `${loan.type} Loan - Balance: ${loan.balance} (Original: ${loan.amount})`).join('\\n');\r\n\r\n    const textContent = `\r\n    KIKOBA Loan Repayment Reminder\r\n    \r\n    Dear ${name},\r\n    \r\n    You have outstanding loan(s) with KIKOBA. Please review your loan details below:\r\n    \r\n    Your Outstanding Loans:\r\n    ${loanText}\r\n    \r\n    Please make your loan repayments as soon as possible. Log into your KIKOBA account to make a payment.\r\n    \r\n    Thank you for being part of the KIKOBA family!\r\n    `;\r\n\r\n    return sendEmail({\r\n        to: email,\r\n        subject,\r\n        html: htmlContent,\r\n        text: textContent,\r\n    });\r\n}\r\n\r\n/**\r\n * Verify email service is configured\r\n */\r\nexport async function verifyEmailConfiguration(): Promise<boolean> {\r\n    try {\r\n        // Verify the transporter connection\r\n        await transporter.verify();\r\n        console.log('✅ Email service configuration verified successfully');\r\n        return true;\r\n    } catch (error) {\r\n        console.error('❌ Email service configuration error:', error);\r\n        return false;\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;AAEA,kCAAkC;AAClC,iEAAiE;AACjE,iEAAiE;AACjE,MAAM,cAAc,mKAAU,CAAC,eAAe,CAAC;IAC3C,SAAS;IACT,MAAM;QACF,MAAM,QAAQ,GAAG,CAAC,UAAU;QAC5B,MAAM,QAAQ,GAAG,CAAC,cAAc;IACpC;AACJ;AAqBO,eAAe,UAAU,OAAqB;IACjD,IAAI;QACA,iBAAiB;QACjB,MAAM,OAAO,MAAM,YAAY,QAAQ,CAAC;YACpC,MAAM,QAAQ,GAAG,CAAC,UAAU,IAAI;YAChC,IAAI,QAAQ,EAAE,IAAI;YAClB,KAAK,QAAQ,GAAG,IAAI;YACpB,SAAS,QAAQ,OAAO;YACxB,MAAM,QAAQ,IAAI,IAAI;YACtB,MAAM,QAAQ,IAAI;QACtB;QAEA,QAAQ,GAAG,CAAC,CAAC,uCAAuC,EAAE,KAAK,SAAS,EAAE;QACtE,OAAO;IACX,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,CAAC,uBAAuB,CAAC,EAAE;QACzC,MAAM;IACV;AACJ;AAKO,eAAe,oBAAoB,KAAa,EAAE,IAAY;IACjE,MAAM,UAAU;IAEhB,MAAM,cAAc,CAAC;;;;gBAIT,EAAE,KAAK;;;;;;;;;;;;;;;;;;;;;;IAsBnB,CAAC;IAED,MAAM,cAAc,CAAC;;;SAGhB,EAAE,KAAK;;;;;;;;;;IAUZ,CAAC;IAED,OAAO,UAAU;QACb,IAAI;QACJ;QACA,MAAM;QACN,MAAM;IACV;AACJ;AAKO,eAAe,yBAAyB,eAAyB,EAAE,WAAqB;IAC3F,MAAM,UAAU;IAEhB,MAAM,cAAc,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;IA4BrB,CAAC;IAED,MAAM,cAAc,CAAC;;;;;;;;;;;;;;;IAerB,CAAC;IAED,OAAO,UAAU;QACb,KAAK;QACL;QACA,MAAM;QACN,MAAM;IACV;AACJ;AAKO,eAAe,iBAAiB,KAAa,EAAE,IAAY,EAAE,KAA+D;IAC/H,MAAM,UAAU;IAEhB,MAAM,cAAc,MACf,GAAG,CACA,CAAA,OACI,CAAC,mCAAmC,EAAE,KAAK,IAAI,CAAC,0BAA0B,EAAE,KAAK,OAAO,CAAC,cAAc,GAAG,YAAY,EAAE,KAAK,MAAM,CAAC,cAAc,GAAG,MAAM,CAAC,EAEnK,IAAI,CAAC;IAEV,MAAM,cAAc,CAAC;;;;gBAIT,EAAE,KAAK;;;;;;;gBAOP,EAAE,YAAY;;;;;;;;;;;;;;;;;IAiB1B,CAAC;IAED,MAAM,WAAW,MAAM,GAAG,CAAC,CAAA,OAAQ,GAAG,KAAK,IAAI,CAAC,iBAAiB,EAAE,KAAK,OAAO,CAAC,YAAY,EAAE,KAAK,MAAM,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC;IAEnH,MAAM,cAAc,CAAC;;;SAGhB,EAAE,KAAK;;;;;IAKZ,EAAE,SAAS;;;;;IAKX,CAAC;IAED,OAAO,UAAU;QACb,IAAI;QACJ;QACA,MAAM;QACN,MAAM;IACV;AACJ;AAKO,eAAe;IAClB,IAAI;QACA,oCAAoC;QACpC,MAAM,YAAY,MAAM;QACxB,QAAQ,GAAG,CAAC;QACZ,OAAO;IACX,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO;IACX;AACJ"}},
    {"offset": {"line": 345, "column": 0}, "map": {"version":3,"sources":["file:///D:/Maono_App/web/app/api/email/send-contribution-reminders/route.ts"],"sourcesContent":["import { sendContributionReminder } from '@/lib/emailService';\r\nimport admin from 'firebase-admin';\r\nimport { NextRequest, NextResponse } from 'next/server';\r\n\r\n// Initialize Firebase Admin (lazy load)\r\nfunction initFirebaseAdmin() {\r\n    if (!admin.apps.length) {\r\n        if (!process.env.FIREBASE_PRIVATE_KEY) {\r\n            console.warn('Missing FIREBASE_PRIVATE_KEY, skipping Admin init');\r\n            return null;\r\n        }\r\n\r\n        try {\r\n            admin.initializeApp({\r\n                credential: admin.credential.cert({\r\n                    projectId: process.env.FIREBASE_PROJECT_ID,\r\n                    clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\r\n                    privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n'),\r\n                }),\r\n            });\r\n        } catch (error) {\r\n            console.error('Firebase Admin initialization error:', error);\r\n        }\r\n    }\r\n    return admin;\r\n}\r\n\r\n/**\r\n * POST /api/email/send-contribution-reminders\r\n * Sends contribution reminder emails to all members and admins with BCC\r\n * \r\n * Authentication: Requires Bearer token with valid admin user\r\n */\r\nexport async function POST(request: NextRequest) {\r\n    const app = initFirebaseAdmin();\r\n    if (!app) {\r\n        return NextResponse.json(\r\n            { error: 'Server misconfiguration: Missing Firebase Credentials' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n\r\n    // Verify Firebase Auth token\r\n    const authHeader = request.headers.get('authorization');\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return NextResponse.json({ error: 'Missing authorization token' }, { status: 401 });\r\n    }\r\n\r\n    const token = authHeader.substring(7);\r\n\r\n    try {\r\n        // Verify the token and check user is an admin\r\n        const decodedToken = await app.auth().verifyIdToken(token);\r\n        const db = app.firestore();\r\n\r\n        const userDoc = await db.collection('users').doc(decodedToken.uid).get();\r\n        const userData = userDoc.data();\r\n\r\n        // Only admins can trigger reminder sends\r\n        if (userData?.role !== 'Admin') {\r\n            return NextResponse.json(\r\n                { error: 'Only admins can send reminder emails' },\r\n                { status: 403 }\r\n            );\r\n        }\r\n\r\n        // Fetch all users (members and admins)\r\n        const usersSnapshot = await db.collection('users').get();\r\n\r\n        const users: { email: string; name: string }[] = [];\r\n        usersSnapshot.forEach((doc: admin.firestore.QueryDocumentSnapshot) => {\r\n            const data = doc.data();\r\n            if (data.email && data.status === 'Active') {\r\n                users.push({\r\n                    email: data.email,\r\n                    name: data.displayName || 'Member',\r\n                });\r\n            }\r\n        });\r\n\r\n        if (users.length === 0) {\r\n            return NextResponse.json({ success: true, message: 'No active users found' });\r\n        }\r\n\r\n        console.log(`Sending contribution reminders to ${users.length} users via BCC...`);\r\n\r\n        // Extract emails and names\r\n        const emailList = users.map(u => u.email);\r\n        const namesList = users.map(u => u.name);\r\n\r\n        // Send single email with all recipients in BCC\r\n        await sendContributionReminder(emailList, namesList);\r\n\r\n        console.log(`✅ Contribution reminder sent via BCC to ${users.length} users`);\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            message: `Contribution reminder sent to ${users.length} users`,\r\n            recipientCount: users.length,\r\n        });\r\n    } catch (error: any) {\r\n        console.error('Error sending contribution reminders:', error);\r\n\r\n        if (error.code === 'auth/invalid-id-token' || error.code === 'auth/argument-error') {\r\n            return NextResponse.json({ error: 'Invalid authorization token' }, { status: 401 });\r\n        }\r\n\r\n        return NextResponse.json(\r\n            { error: 'Failed to send contribution reminders', details: error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}